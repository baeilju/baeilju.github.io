박용주 강사
apexacme@uengine.org

p.사전준비
크롬 브라우저 설치되어야 함
www.msaez.io 접속
크롬 설정 변경
설정 / 쿠키 허용, 팝업 허용 dev.azure.com
portal.azure.com 접속

p.3
마이크로서비스를 클라우드 환경에서 Cloud runtime에 배포되기 위한 운영환경
매우 복잡하다
코드 커밋만하면 자동 빌드, 배포함

p.4
전반전
CI

p.5
후반전
CD 단계 : 컨테이너 런타임에 싣는 것
deliver vs deployment 차이 
deploy to production 과정 자동화 여부

CI/CD의 출발역
형상관리 서버... 어디에 있느냐?
CI : 도커 이미지 생성까지

p.6
마이크로서비스 개발
자율적 조직이 any time pipeline을 탈 수 있게.
다운타임없이 안정적으로 유지보수

p.8

p.9
CI/CD를 위해서는 도커와 쿠버네티스 기본 개념을 알아야 함

p.11
도커 이미지는 마이크로서비스가 집약된 하나의 바이너리 파일
사용자가 접속한 상태에서 컨테이너가 된다?

repository_name/image_name:05.17
repository_name/image_name:latest

이미지, 버전은 사용자 마음대로...
저장소 이름은 반드시 룰을 지켜야 한다?

ghcr.io/gkedu/oder:1.1.1
ghcr -> github container registry

gdhong.azurecr.io/order:1.0
baeilju.azurecr.io/order:1.0
<- azure의 image 형식

repository_name이 없으면 docker hub
url이 아닌 스트링이면 docker hub 계정
version이 없으면 latest


<실습>
hub.docker.com 접속
ngine
mariadb

이미지 및 버전 검색 실습

p.13
image를 pull, run하면 container임
image/container는 class, instance 관계
그전에 image를 push하여야 함

p.14
도커의 이미지는 layered 구조... 포개어서 만든다
base / runtime / web app....

p.16
빌드 시 dockerfile 필수

FROM #베이스 이미지 지정
RUN #실행코드
COPY dev.jar layered_image.jar
COPY는 로컬 파일을 베이스 이미지 위로 복사함
ENV
ENTRYPOINT 컨테이너 실행 시 기본 명령어

<3. Kubernetes Basic and Hands-on>
p.18
Container Orchestration Features
- container 자동 배치, 복제
- 로드 밸런싱
- 장애복구
- 외부 서비스 노출
- 확장, 축소
- 서비스 간 인터페이스

p.25
K8S에서 Deployment를 생성하면 자동으로
ReplicaSet > Pod (Containers...)를 만들어 준다
*Deployment 생성 시 Image를 파라미터로 줘야함

Service -> L4


az login



<4.>
portal.azure.com 접속
user11@skusers01gmail.onmicrosoft.com
SKCC!234
암호변경
SKCCADMIN!234

탐색 > 구독
구독 이름 확인 : 종량제2
*반드시 하나 있어야 함, 두개 이상이면 설정 필요

p.28
azure subscription 아래
Resource Group을 만들고...
그 아래 ACR Registry와 K8S를 서비스를 함
순서대로 각각 만들어 나간다

work node 2로 설정? 일단...
배포 실패하면... 그냥 다시...

docker build > push > run (k8s: AKS container runtime)
*build는 docker client
>> 교육 시 msaez.io에서 진행






-----------------------------------
리소스그룹: User11-rsrcgrp
K8S클러스터: user11-aks
ContainerRegistry: 
user11.azurecr.io/

- 터미널(cloud client, k8s client 기 설치)에서 az 연결
$ az login


- K8s Client 에 Target Context 설정
$ az aks get-credentials --resource-group (RESOURCE-GROUP-NAME) --name (Cluster-NAME)
$ az aks get-credentials --resource-group User11-rsrcgrp --name user11-aks

kubectl get all

- Azure AKS에 ACR Attach 설정

$ az aks update -n (Cluster-NAME) -g (RESOURCE-GROUP-NAME) --attach-acr (REGISTRY-NAME)
$ az aks update -n user11-aks -g User11-rsrcgrp --attach-acr user11


(참고 예제)새로운 터미널 창 열고

$ kubectl apply -f https://raw.githubusercontent.com/Azure-Samples/azure-voting-app-redis/master/azure-vote-all-in-one-redis.yaml
$ kubectl delete deploy --all
$ kubectl delete service --all


----------브라우저에서 따로 실행---------------
$ az login -u USER-ID -p PASSWORD

- aks 생성
$ az aks create --resource-group (RESOURCE-GROUP-NAME) --name (Cluster-NAME) --node-count 2 --enable-addons monitoring --generate-ssh-keys

- ACR (Azure Container Registry) 생성
$ az acr create --resource-group (RESOURCE-GROUP-NAME) --name (REGISTRY-NAME) --sku Basic





dev.azure.com
devops관련 내용은 다 여기 있음
Pipeline > Pipelines CI단계
Pipeline > Release CD단계


user110709
user11-prj-1

접속 후...

p.40

github.com/event-storming/monolith
Fork로 repository 가져옴

순서대로 진행하고...

Agent Spec을 Ubuntu로 변경
-> Pipeline을 러닝할 가상머신

p.50

$(System.DefaultWorkingDirectory)/_user11-prj-1-CI/drop/azure/service.yaml

sed -i "s/latest/$(Build.BuildId)/g" $(System.DefaultWorkingDirectory)/_user11-prj-1-CI/drop/azure/deploy.yaml

터미널에서 모니터링
watch kubectl get all

--------------------------------------------------
p.67
배포전략 중 1개
blue/green



















































































